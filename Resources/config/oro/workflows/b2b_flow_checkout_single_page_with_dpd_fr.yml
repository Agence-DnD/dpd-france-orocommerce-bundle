workflows:
    b2b_flow_checkout_single_page_with_dpd_fr:
        entity: Oro\Bundle\CheckoutBundle\Entity\Checkout
        entity_attribute: checkout
        steps_display_ordered: true
        priority: 220
        defaults:
            active: false
        applications:
            - commerce
        exclusive_active_groups:
            - b2b_checkout_flow
        exclusive_record_groups:
            - b2b_checkout_flow
        transition_definitions:
            __start___definition:
                actions:
                    -
                        '@assign_value':
                            - $shipping_method
                            - null
                    -
                        '@assign_value':
                            - $payment_save_for_later
                            - true
                    -
                        '@delete_checkout_state':
                            conditions:
                                '@not_blank': $state_token
                            parameters:
                                entity: $checkout
                                token: $state_token
                    -
                        '@generate_uuid':
                            conditions:
                                '@blank': $state_token
                            parameters:
                                attribute: $state_token
                    -
                        '@run_action_group':
                            action_group: b2b_flow_checkout_create_guest_customer_user
                            parameters_mapping:
                                checkout: $checkout
                    -
                        '@assign_value':
                            - $billing_address_has_shipping
                            - $ship_to_billing_address
                    -
                        '@tree':
                            conditions:
                                '@empty': $billing_address
                            actions:
                                -
                                    '@call_service_method':
                                        attribute: $.result.customerUserAddresses
                                        service: oro_order.manager.order_address
                                        method: getGroupedAddresses
                                        method_parameters:
                                            - $checkout
                                            - billing
                                -
                                    '@call_service_method':
                                        attribute: $billing_address
                                        service: oro_order.manager.order_address
                                        method: updateFromAbstract
                                        method_parameters:
                                            - $.result.customerUserAddresses.defaultAddress
                    -
                        '@tree':
                            conditions:
                                '@empty': $shipping_address
                            actions:
                                -
                                    '@call_service_method':
                                        attribute: $.result.customerUserAddresses
                                        service: oro_order.manager.order_address
                                        method: getGroupedAddresses
                                        method_parameters:
                                            - $checkout
                                            - shipping
                                -
                                    '@call_service_method':
                                        attribute: $shipping_address
                                        service: oro_order.manager.order_address
                                        method: updateFromAbstract
                                        method_parameters:
                                            - $.result.customerUserAddresses.defaultAddress
                    -
                        '@run_action_group':
                            action_group: b2b_flow_checkout_update_billing_address
                            parameters_mapping:
                                checkout: $checkout
                                disallow_shipping_address_edit: $disallow_shipping_address_edit
                            results:
                                data.billing_address_has_shipping: $.billing_address_has_shipping
                    -
                        '@run_action_group':
                            action_group: b2b_flow_checkout_update_shipping_address
                            parameters_mapping:
                                checkout: $checkout
                    -
                        '@call_service_method':
                            service: oro_checkout.action.default_shipping_method_setter
                            method: setDefaultShippingMethod
                            method_parameters:
                                - $checkout
                    -
                        '@run_action_group':
                            action_group: oro_update_shipping_price
                            parameters_mapping:
                                checkout: $checkout
                preactions: {  }
                preconditions: {  }
                conditions: {  }
            start_from_quickorderform_definition:
                preactions:
                    -
                        '@call_service_method':
                            conditions:
                                '@blank': $.result.isAllowed
                            parameters:
                                attribute: $.result.isAllowed
                                service: oro_shopping_list.processor.quick_add_to_checkout
                                method: isAllowed
                    -
                        '@call_service_method':
                            conditions:
                                '@blank': $.result.isReachedLimit
                            parameters:
                                attribute: $.result.isReachedLimit
                                service: oro_shopping_list.manager.shopping_list_limit
                                method: isReachedLimit
                    -
                        '@call_service_method':
                            conditions:
                                '@blank': $.result.shoppingListLimit
                            parameters:
                                attribute: $.result.shoppingListLimit
                                service: oro_shopping_list.manager.shopping_list_limit
                                method: getShoppingListLimitForUser
                    -
                        '@call_service_method':
                            conditions:
                                '@blank': $.result.isCheckoutAllowed
                            parameters:
                                service: oro_checkout.condition.is_workflow_start_from_shopping_list_allowed
                                method: isAllowedForAny
                                attribute: $.result.isCheckoutAllowed
                    -
                        '@call_service_method':
                            conditions:
                                '@blank': $.result.isCurrentShoppingListEmpty
                            parameters:
                                service: oro_shopping_list.manager.current_shopping_list
                                method: isCurrentShoppingListEmpty
                                attribute: $.result.isCurrentShoppingListEmpty
                    -
                        '@assign_value':
                            - $.result.doShowConfirmation
                            - false
                    -
                        '@assign_value':
                            conditions:
                                '@and':
                                    -
                                        '@equal':
                                            - $.result.isReachedLimit
                                            - true
                                    -
                                        '@equal':
                                            - $.result.isCurrentShoppingListEmpty
                                            - false
                            parameters:
                                - $.result.doShowConfirmation
                                - true
                preconditions:
                    '@and':
                        -
                            '@equal':
                                - true
                                - $.result.isAllowed
                        -
                            '@equal':
                                - true
                                - $.result.isCheckoutAllowed
                actions:
                    -
                        '@delete_checkout_state':
                            conditions:
                                '@not_blank': $state_token
                            parameters:
                                entity: $checkout
                                token: $state_token
                conditions: {  }
            start_from_shoppinglist_definition:
                preactions:
                    -
                        '@find_entity':
                            conditions:
                                '@and':
                                    -
                                        '@not_blank': $init_context
                                    -
                                        '@blank': $.result.shoppingList
                            parameters:
                                class: $init_context.entityClass
                                identifier: $init_context.entityId
                                attribute: $.result.shoppingList
                    -
                        '@tree':
                            conditions:
                                '@and':
                                    -
                                        '@not_blank': $.result.shoppingList
                                    -
                                        '@blank': $.result.extendableConditionShoppingListStart
                            actions:
                                -
                                    '@assign_value':
                                        - $.result.extendableConditionShoppingListStart
                                        - false
                                -
                                    '@assign_value':
                                        conditions:
                                            '@extendable':
                                                events:
                                                    - extendable_condition.shopping_list_start
                                        parameters:
                                            - $.result.extendableConditionShoppingListStart
                                            - true
                    -
                        '@call_service_method':
                            conditions:
                                '@blank': $isAllowed
                            parameters:
                                service: oro_checkout.condition.is_workflow_start_from_shopping_list_allowed
                                method: isAllowedForAny
                                attribute: $isAllowed
                    -
                        '@call_service_method':
                            conditions:
                                '@and':
                                    -
                                        '@not_blank': $.result.shoppingList
                                    -
                                        '@blank': $.result.shoppingListHasEmptyMatrix
                            parameters:
                                service: oro_shopping_list.manager.empty_matrix_grid
                                method: hasEmptyMatrix
                                method_parameters:
                                    - $.result.shoppingList
                                attribute: $.result.shoppingListHasEmptyMatrix
                preconditions:
                    '@and':
                        -
                            '@equal':
                                - $isAllowed
                                - true
                        -
                            '@not_empty': $.result.shoppingList
                        -
                            '@has_elements': $.result.shoppingList.lineItems
                        -
                            '@equal':
                                - $.result.extendableConditionShoppingListStart
                                - true
                actions:
                    -
                        '@run_action_group':
                            action_group: start_shoppinglist_checkout
                            parameters_mapping:
                                shoppingList: $.result.shoppingList
                                showErrors: true
                            results:
                                data.checkout: $.checkout
                                result.redirectUrl: $.redirectUrl
                    -
                        '@delete_checkout_state':
                            conditions:
                                '@not_blank': $state_token
                            parameters:
                                entity: $checkout
                                token: $state_token
                conditions: {  }
            unblock_and_recalculate_definition:
                actions:
                    -
                        '@assign_value':
                            -
                                - $payment_method
                                - null
                            -
                                - $payment_in_progress
                                - false
                    -
                        '@generate_uuid': $state_token
                preactions: {  }
                preconditions: {  }
                conditions: {  }
            payment_error_definition:
                actions:
                    -
                        '@assign_value':
                            -
                                - $payment_method
                                - null
                            -
                                - $payment_in_progress
                                - false
                    -
                        '@remove_entity':
                            conditions:
                                '@not_empty': $order
                            parameters:
                                - $order
                    -
                        '@unset_value':
                            - $.data.order
                    -
                        '@generate_uuid': $state_token
                preactions: {  }
                preconditions: {  }
                conditions: {  }
            save_state_definition:
                actions:
                    -
                        '@assign_value':
                            conditions:
                                '@not':
                                    -
                                        '@is_consents_accepted':
                                            acceptedConsents: $customerConsents
                            parameters:
                                - $consents_available
                                - true
                    -
                        '@save_accepted_consents':
                            acceptedConsents: $customerConsents
                    -
                        '@assign_value':
                            conditions:
                                '@not_empty': $late_registration.email
                            parameters:
                                - $email
                                - $late_registration.email
                    -
                        '@assign_value':
                            - $billing_address_has_shipping
                            - $ship_to_billing_address
                    -
                        '@tree':
                            conditions:
                                '@empty': $billing_address
                            actions:
                                -
                                    '@call_service_method':
                                        attribute: $.result.customerUserAddresses
                                        service: oro_order.manager.order_address
                                        method: getGroupedAddresses
                                        method_parameters:
                                            - $checkout
                                            - billing
                                -
                                    '@call_service_method':
                                        attribute: $billing_address
                                        service: oro_order.manager.order_address
                                        method: updateFromAbstract
                                        method_parameters:
                                            - $.result.customerUserAddresses.defaultAddress
                    -
                        '@tree':
                            conditions:
                                '@empty': $shipping_address
                            actions:
                                -
                                    '@call_service_method':
                                        attribute: $.result.customerUserAddresses
                                        service: oro_order.manager.order_address
                                        method: getGroupedAddresses
                                        method_parameters:
                                            - $checkout
                                            - shipping
                                -
                                    '@call_service_method':
                                        attribute: $shipping_address
                                        service: oro_order.manager.order_address
                                        method: updateFromAbstract
                                        method_parameters:
                                            - $.result.customerUserAddresses.defaultAddress
                    -
                        '@run_action_group':
                            action_group: b2b_flow_checkout_update_billing_address
                            parameters_mapping:
                                checkout: $checkout
                                disallow_shipping_address_edit: $disallow_shipping_address_edit
                            results:
                                data.billing_address_has_shipping: $.billing_address_has_shipping
                    -
                        '@run_action_group':
                            action_group: b2b_flow_checkout_update_shipping_address
                            parameters_mapping:
                                checkout: $checkout
                    -
                        '@run_action_group':
                            action_group: oro_update_shipping_price
                            parameters_mapping:
                                checkout: $checkout
                    -
                        '@tree':
                            conditions:
                                '@empty': $checkout.shippingCost
                            actions:
                                -
                                    '@unset_value': $checkout.shippingMethod
                                -
                                    '@call_service_method':
                                        service: oro_checkout.action.default_shipping_method_setter
                                        method: setDefaultShippingMethod
                                        method_parameters:
                                            - $checkout
                    -
                        '@delete_checkout_state':
                            entity: $checkout
                            token: $state_token
                    -
                        '@generate_checkout_state_snapshot':
                            entity: $checkout
                            attribute: $.result.currentCheckoutState
                    -
                        '@save_checkout_state':
                            entity: $checkout
                            state: $.result.currentCheckoutState
                            token: $state_token
                    -
                        '@assign_value':
                            - $.result.responseData.stateSaved
                            - true
                preactions: {  }
                preconditions: {  }
                conditions: {  }
            create_order_transition_definition:
                preactions:
                    -
                        '@call_service_method':
                            conditions:
                                '@blank': $.result.paymentContext
                            parameters:
                                service: oro_checkout.provider.payment_context
                                method: getContext
                                method_parameters:
                                    - $checkout
                                attribute: $.result.paymentContext
                    -
                        '@run_action_group':
                            action_group: order_line_items_not_empty
                            parameters_mapping:
                                checkout: $checkout
                            results:
                                result.orderLineItemsNotEmpty: $.orderLineItemsNotEmpty
                                result.orderLineItemsNotEmptyForRfp: $.orderLineItemsNotEmptyForRfp
                    -
                        '@tree':
                            conditions:
                                '@blank': $.result.extendableConditionCheckout
                            actions:
                                -
                                    '@assign_value':
                                        - $.result.extendableConditionCheckout
                                        - false
                                -
                                    '@assign_value':
                                        conditions:
                                            '@extendable':
                                                events:
                                                    - extendable_condition.checkout
                                        parameters:
                                            - $.result.extendableConditionCheckout
                                            - true
                    -
                        '@tree':
                            conditions:
                                '@blank': $.result.extendableConditionPreOrderCreate
                            actions:
                                -
                                    '@assign_value':
                                        - $.result.extendableConditionPreOrderCreate
                                        - false
                                -
                                    '@assign_value':
                                        conditions:
                                            '@extendable':
                                                events:
                                                    - extendable_condition.pre_order_create
                                        parameters:
                                            - $.result.extendableConditionPreOrderCreate
                                            - true
                    -
                        '@tree':
                            conditions:
                                '@blank': $.result.hasApplicablePaymentMethods
                            actions:
                                -
                                    '@assign_value':
                                        - $.result.hasApplicablePaymentMethods
                                        - false
                                -
                                    '@assign_value':
                                        conditions:
                                            '@has_applicable_payment_methods': $.result.paymentContext
                                        parameters:
                                            - $.result.hasApplicablePaymentMethods
                                            - true
                    -
                        '@tree':
                            conditions:
                                '@not_blank': $checkout.shippingMethod
                            actions:
                                -
                                    '@assign_value':
                                        - $.result.shippingMethodHasEnabledShippingRules
                                        - false
                                -
                                    '@assign_value':
                                        conditions:
                                            '@shipping_method_has_enabled_shipping_rules': $checkout.shippingMethod
                                        parameters:
                                            - $.result.shippingMethodHasEnabledShippingRules
                                            - true
                    - '@flash_message':
                            conditions:
                                '@and':
                                    -
                                        '@equal':
                                            - $payment_in_progress
                                            - true
                                    -
                                        '@equal':
                                            - $checkout.completed
                                            - false
                                    -
                                        '@check_request':
                                            parameters:
                                                is_ajax: false
                                    -
                                        '@not':
                                            -
                                                '@check_request':
                                                    parameters:
                                                        expected_key: transition
                                                        expected_value: purchase
                            message: oro.checkout.workflow.condition.payment_has_not_been_processed.message
                            type: warning
                    -
                        '@assign_url':
                            conditions:
                                '@blank': $.result.saveStateUrl
                            parameters:
                                attribute: $.result.saveStateUrl
                                route: oro_checkout_frontend_checkout
                                route_parameters:
                                    id: $checkout.id
                                    transition: save_state
                preconditions:
                    '@and':
                        -
                            '@equal':
                                - $checkout.completed
                                - false
                        -
                            '@equal':
                                parameters:
                                    - $.result.orderLineItemsNotEmptyForRfp
                                    - true
                        -
                            '@equal':
                                parameters:
                                    - $.result.orderLineItemsNotEmpty
                                    - true
                        -
                            '@equal':
                                parameters:
                                    - $.result.hasApplicablePaymentMethods
                                    - true
                        -
                            '@and':
                                -
                                    '@not_blank': $checkout.shippingMethod
                                -
                                    '@equal':
                                        parameters:
                                            - $.result.shippingMethodHasEnabledShippingRules
                                            - true
                        -
                            '@quote_acceptable':
                                - $checkout.sourceEntity
                                - true
                        -
                            '@equal':
                                - $.result.extendableConditionCheckout
                                - true
                        -
                            '@equal':
                                - $.result.extendableConditionPreOrderCreate
                                - true
                conditions:
                    '@and':
                        -
                            '@check_request':
                                parameters:
                                    is_ajax: true
                                    expected_key: _wid
                                    expected_value: ajax_checkout
                        -
                            '@is_checkout_state_valid':
                                parameters:
                                    entity: $checkout
                                    token: $state_token
                                    current_state: $.result.currentCheckoutState
                        -
                            '@is_consents_accepted':
                                acceptedConsents: $customerConsents
                                type: warning
                        -
                            '@extendable':
                                events:
                                    - extendable_condition.before_order_create
                        -
                            '@validate_checkout_addresses':
                                parameters: $checkout
                        -
                            '@not_empty':
                                parameters: $checkout.shippingMethod
                        -
                            '@not_empty':
                                parameters: $checkout.paymentMethod
                        -
                            '@payment_method_applicable':
                                payment_method: $checkout.paymentMethod
                                context: $.result.paymentContext
                actions:
                    -
                        '@save_accepted_consents':
                            acceptedConsents: $customerConsents
                    -
                        '@run_action_group':
                            action_group: oro_update_shipping_price
                            parameters_mapping:
                                checkout: $checkout
                    -
                        '@run_action_group':
                            action_group: b2b_flow_checkout_place_order
                            parameters_mapping:
                                checkout: $checkout
                            results:
                                data.order: $.order
                    -
                        '@assign_constant_value':
                            - $.result.validateAction
                            - 'Oro\Bundle\PaymentBundle\Method\PaymentMethodInterface::VALIDATE'
                    -
                        '@tree':
                            conditions:
                                '@and':
                                    -
                                        '@equal':
                                            - $payment_validate
                                            - true
                                    -
                                        '@payment_method_supports':
                                            payment_method: $checkout.paymentMethod
                                            action: $.result.validateAction
                            actions:
                                -
                                    '@assign_url':
                                        attribute: $.result.successUrl
                                        route: oro_checkout_frontend_checkout
                                        route_parameters:
                                            id: $checkout.id
                                            transition: purchase
                                -
                                    '@assign_url':
                                        attribute: $.result.failureUrl
                                        route: oro_checkout_frontend_checkout
                                        route_parameters:
                                            id: $checkout.id
                                            transition: payment_error
                                -
                                    '@payment_validate':
                                        attribute: $.result.responseData
                                        object: $checkout
                                        paymentMethod: $checkout.paymentMethod
                                        transactionOptions:
                                            saveForLaterUse: $payment_save_for_later
                                            successUrl: $.result.successUrl
                                            failureUrl: $.result.failureUrl
                                            additionalData: $additional_data
                                            checkoutId: $checkout.id
                    -
                        '@run_action_group':
                            action_group: b2b_flow_checkout_update_guest_customer_user
                            parameters_mapping:
                                checkout: $checkout
                                email: $email
                                billing_address: $billing_address
                    -
                        '@assign_value':
                            conditions:
                                '@and':
                                    -
                                        '@not_equal':
                                            - $payment_validate
                                            - false
                                    -
                                        '@not_equal':
                                            - '$.result.responseData[successful]'
                                            - true
                                    -
                                        '@payment_method_supports':
                                            payment_method: $checkout.paymentMethod
                                            action: $.result.validateAction
                            parameters:
                                - $.result.updateCheckoutState
                                - true
                    -
                        '@tree':
                            conditions:
                                '@or':
                                    -
                                        '@equal':
                                            - $payment_validate
                                            - false
                                    -
                                        '@equal':
                                            - '$.result.responseData[successful]'
                                            - true
                                    -
                                        '@not':
                                            -
                                                '@payment_method_supports':
                                                    payment_method: $checkout.paymentMethod
                                                    action: $.result.validateAction
                            actions:
                                -
                                    '@get_available_workflow_by_record_group':
                                        attribute: $.result.currentWorkflow
                                        entity_class: Oro\Bundle\CheckoutBundle\Entity\Checkout
                                        group_name: b2b_checkout_flow
                                -
                                    '@transit_workflow':
                                        entity: $checkout
                                        transition: purchase
                                        workflow: $.result.currentWorkflow.name
                                        if_allowed: true
            purchase_transition_definition:
                preactions:
                    -
                        '@call_service_method':
                            conditions:
                                '@blank': $.result.paymentContext
                            parameters:
                                service: oro_checkout.provider.payment_context
                                method: getContext
                                method_parameters:
                                    - $checkout
                                attribute: $.result.paymentContext
                    -
                        '@tree':
                            conditions:
                                '@check_request':
                                    parameters:
                                        expected_key: transition
                                        expected_value: purchase
                            actions:
                                -
                                    '@run_action_group':
                                        action_group: order_line_items_not_empty
                                        parameters_mapping:
                                            checkout: $checkout
                                        results:
                                            result.orderLineItemsNotEmpty: $.orderLineItemsNotEmpty
                                            result.orderLineItemsNotEmptyForRfp: $.orderLineItemsNotEmptyForRfp
                                -
                                    '@tree':
                                        conditions:
                                            '@blank': $.result.extendableConditionCheckout
                                        actions:
                                            -
                                                '@assign_value':
                                                    - $.result.extendableConditionCheckout
                                                    - false
                                            -
                                                '@assign_value':
                                                    conditions:
                                                        '@extendable':
                                                            events:
                                                                - extendable_condition.checkout
                                                    parameters:
                                                        - $.result.extendableConditionCheckout
                                                        - true
                                -
                                    '@tree':
                                        conditions:
                                            '@blank': $.result.extendableConditionBeforeOrderCreate
                                        actions:
                                            -
                                                '@assign_value':
                                                    - $.result.extendableConditionBeforeOrderCreate
                                                    - false
                                            -
                                                '@assign_value':
                                                    conditions:
                                                        '@extendable':
                                                            events:
                                                                - extendable_condition.before_order_create
                                                    parameters:
                                                        - $.result.extendableConditionBeforeOrderCreate
                                                        - true
                                -
                                    '@tree':
                                        conditions:
                                            '@blank': $.result.paymentMethodApplicable
                                        actions:
                                            -
                                                '@assign_value':
                                                    - $.result.paymentMethodApplicable
                                                    - false
                                            -
                                                '@assign_value':
                                                    conditions:
                                                        '@payment_method_applicable':
                                                            payment_method: $checkout.paymentMethod
                                                            context: $.result.paymentContext
                                                    parameters:
                                                        - $.result.paymentMethodApplicable
                                                        - true
                                -
                                    '@tree':
                                        conditions:
                                            '@blank': $.result.shippingMethodHasEnabledShippingRules
                                        actions:
                                            -
                                                '@assign_value':
                                                    - $.result.shippingMethodHasEnabledShippingRules
                                                    - false
                                            -
                                                '@assign_value':
                                                    conditions:
                                                        '@shipping_method_has_enabled_shipping_rules': $checkout.shippingMethod
                                                    parameters:
                                                        - $.result.shippingMethodHasEnabledShippingRules
                                                        - true
                    -
                        '@assign_constant_value':
                            - $.result.validateAction
                            - 'Oro\Bundle\PaymentBundle\Method\PaymentMethodInterface::VALIDATE'
                    -
                        '@call_service_method':
                            conditions:
                                '@blank': $.result.validatePaymentTransaction
                            parameters:
                                service: oro_payment.provider.payment_transaction
                                method: getActiveValidatePaymentTransaction
                                method_parameters:
                                    - $payment_method
                                attribute: $.result.validatePaymentTransaction
                conditions:
                    '@and':
                        -
                            '@equal':
                                - $checkout.completed
                                - false
                        -
                            '@not_empty': $order
                        -
                            '@or':
                                -
                                    '@not_empty':
                                        - $.result.validatePaymentTransaction
                                -
                                    '@not':
                                        -
                                            '@payment_method_supports':
                                                payment_method: $checkout.paymentMethod
                                                action: $.result.validateAction
                        -
                            '@or':
                                -
                                    '@not':
                                        -
                                            '@check_request':
                                                parameters:
                                                    expected_key: transition
                                                    expected_value: purchase
                                -
                                    '@and':
                                        -
                                            '@equal':
                                                parameters:
                                                    - $.result.orderLineItemsNotEmptyForRfp
                                                    - true
                                        -
                                            '@equal':
                                                parameters:
                                                    - $.result.orderLineItemsNotEmpty
                                                    - true
                                        -
                                            '@equal':
                                                parameters:
                                                    - $.result.shippingMethodHasEnabledShippingRules
                                                    - true
                                        -
                                            '@equal':
                                                parameters:
                                                    - $.result.paymentMethodApplicable
                                                    - true
                                        -
                                            '@quote_acceptable':
                                                - $checkout.sourceEntity
                                                - true
                                        -
                                            '@equal':
                                                - $.result.extendableConditionCheckout
                                                - true
                                        -
                                            '@equal':
                                                - $.result.extendableConditionBeforeOrderCreate
                                                - true
                actions:
                    -
                        '@assign_value':
                            - $payment_in_progress
                            - true
                    -
                        '@run_action_group':
                            action_group: b2b_flow_checkout_purchase
                            parameters_mapping:
                                checkout: $checkout
                                order: $order
                                transactionOptions:
                                    additionalData: $additional_data
                            results:
                                result.responseData: $.responseData
                    -
                        '@extendable':
                            events:
                                - extendable_action.finish_checkout
                    -
                        '@redirect':
                            conditions:
                                '@equal':
                                    - true
                                    - '$.result.responseData[purchaseSuccessful]'
                            route: oro_checkout_frontend_checkout
                            route_parameters:
                                id: $checkout.id
                                transition: finish_checkout
                    -
                        '@redirect':
                            conditions:
                                '@equal':
                                    - false
                                    - '$.result.responseData[purchaseSuccessful]'
                            route: oro_checkout_frontend_checkout
                            route_parameters:
                                id: $checkout.id
                                transition: payment_error
                preconditions: {  }
            finish_checkout_definition:
                conditions:
                    '@and':
                        -
                            '@not_empty':
                                - $order
                        -
                            '@equal':
                                - $payment_in_progress
                                - true
                actions:
                    -
                        '@run_action_group':
                            action_group: handle_late_registration
                            parameters_mapping:
                                checkout: $checkout
                                order: $order
                                late_registration_data: $late_registration
                    -
                        '@run_action_group':
                            action_group: b2b_flow_checkout_finish_checkout
                            parameters_mapping:
                                checkout: $checkout
                                order: $order
                                auto_remove_source: $auto_remove_source
                                allow_manual_source_remove: $allow_manual_source_remove
                                remove_source: $remove_source
                                clear_source: $clear_source
                    -
                        '@delete_checkout_state':
                            entity: $checkout
                preactions: {  }
                preconditions: {  }
        transitions:
            __start__:
                is_start: true
                is_hidden: true
                transition_definition: __start___definition
                step_to: checkout
                is_unavailable_hidden: false
                acl_message: null
                frontend_options: {  }
                form_type: Oro\Bundle\WorkflowBundle\Form\Type\WorkflowTransitionType
                display_type: dialog
                destination_page: ''
                form_options: {  }
                page_template: null
                dialog_template: null
                init_entities: {  }
                init_routes: {  }
                init_datagrids: {  }
                init_context_attribute: init_context
                message_parameters: {  }
                triggers: {  }
            start_from_quote:
                is_start: true
                is_hidden: true
                transition_definition: __start___definition
                step_to: checkout
                is_unavailable_hidden: false
                acl_message: null
                frontend_options: {  }
                form_type: Oro\Bundle\WorkflowBundle\Form\Type\WorkflowTransitionType
                display_type: dialog
                destination_page: ''
                form_options: {  }
                page_template: null
                dialog_template: null
                init_entities: {  }
                init_routes: {  }
                init_datagrids: {  }
                init_context_attribute: init_context
                message_parameters: {  }
                triggers: {  }
            start_from_quote_as_guest:
                is_start: true
                is_hidden: true
                transition_definition: __start___definition
                step_to: checkout
                is_unavailable_hidden: false
                acl_message: null
                frontend_options: {  }
                form_type: Oro\Bundle\WorkflowBundle\Form\Type\WorkflowTransitionType
                display_type: dialog
                destination_page: ''
                form_options: {  }
                page_template: null
                dialog_template: null
                init_entities: {  }
                init_routes: {  }
                init_datagrids: {  }
                init_context_attribute: init_context
                message_parameters: {  }
                triggers: {  }
            start_from_shoppinglist:
                is_start: true
                is_unavailable_hidden: true
                transition_definition: start_from_shoppinglist_definition
                frontend_options:
                    icon: fa-briefcase
                    data:
                        component_name: oro_shopping_list_matrix_to_create_order
                        page-component-module: oroshoppinglist/js/app/components/shoppinglist-create-order-button-component
                        page-component-options:
                            component_name: '[name$="[component]"]'
                            hasEmptyMatrix: $.result.shoppingListHasEmptyMatrix
                init_routes:
                    - oro_shopping_list_frontend_view
                    - oro_shopping_list_frontend_update
                init_entities:
                    - Oro\Bundle\ShoppingListBundle\Entity\ShoppingList
                acl_resource:
                    - CHECKOUT_CREATE
                    - $.result.shoppingList
                step_to: checkout
                is_hidden: false
                acl_message: null
                form_type: Oro\Bundle\WorkflowBundle\Form\Type\WorkflowTransitionType
                display_type: dialog
                destination_page: ''
                form_options: {  }
                page_template: null
                dialog_template: null
                init_datagrids: {  }
                init_context_attribute: init_context
                message_parameters: {  }
                triggers: {  }
            start_from_quickorderform:
                is_start: true
                is_unavailable_hidden: true
                transition_definition: start_from_quickorderform_definition
                frontend_options:
                    icon: fa-clipboard
                    data:
                        component_name: oro_shopping_list_to_checkout_quick_add_processor
                        transition_name: start_from_quickorderform
                        page-component-module: oroproduct/js/app/components/quick-add-form-button-component
                        page-component-options:
                            transition_name: '[name$="[transition]"]'
                            component_name: '[name$="[component]"]'
                            confirmation: $.result.doShowConfirmation
                            shopping_list_limit: $.result.shoppingListLimit
                init_routes:
                    - oro_product_frontend_quick_add
                    - oro_product_frontend_quick_add_copy_paste
                    - oro_product_frontend_quick_add_import
                acl_resource:
                    - CREATE
                    - 'entity:commerce@Oro\Bundle\CheckoutBundle\Entity\Checkout'
                step_to: checkout
                is_hidden: false
                acl_message: null
                form_type: Oro\Bundle\WorkflowBundle\Form\Type\WorkflowTransitionType
                display_type: dialog
                destination_page: ''
                form_options: {  }
                page_template: null
                dialog_template: null
                init_entities: {  }
                init_datagrids: {  }
                init_context_attribute: init_context
                message_parameters: {  }
                triggers: {  }
            finish_checkout:
                transition_definition: finish_checkout_definition
                is_hidden: true
                step_to: order_created
                is_start: false
                is_unavailable_hidden: false
                acl_message: null
                frontend_options: {  }
                form_type: Oro\Bundle\WorkflowBundle\Form\Type\WorkflowTransitionType
                display_type: dialog
                destination_page: ''
                form_options: {  }
                page_template: null
                dialog_template: null
                init_entities: {  }
                init_routes: {  }
                init_datagrids: {  }
                init_context_attribute: init_context
                message_parameters: {  }
                triggers: {  }
            payment_error:
                transition_definition: payment_error_definition
                is_hidden: true
                step_to: checkout
                is_start: false
                is_unavailable_hidden: false
                acl_message: null
                frontend_options: {  }
                form_type: Oro\Bundle\WorkflowBundle\Form\Type\WorkflowTransitionType
                display_type: dialog
                destination_page: ''
                form_options: {  }
                page_template: null
                dialog_template: null
                init_entities: {  }
                init_routes: {  }
                init_datagrids: {  }
                init_context_attribute: init_context
                message_parameters: {  }
                triggers: {  }
            save_state:
                step_to: checkout
                transition_definition: save_state_definition
                is_hidden: true
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                form_options:
                    form_init:
                        -
                            '@tree':
                                conditions:
                                    '@and':
                                        -
                                            '@not_empty': $checkout.customerUser
                                        -
                                            '@equal':
                                                - $checkout.customerUser.isGuest
                                                - false
                                actions:
                                    -
                                        '@assign_value':
                                            - $customerConsents
                                            - null
                    attribute_fields:
                        billing_address:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\CheckoutAddressSelectType
                            options:
                                object: $checkout
                                address_type: billing
                                required: true
                                translation_domain: messages
                        shipping_address:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\CheckoutAddressSelectType
                            options:
                                object: $checkout
                                address_type: shipping
                                required: true
                                disabled: $disallow_shipping_address_edit
                                translation_domain: messages
                        ship_to_billing_address:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\ShipToBillingAddressType
                            options: null
                        shipping_method:
                            options: null
                        shipping_method_type:
                            options: null
                        # @ADD DND START
                        delivery_phone:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                            options: null
                        dpd_fr_relay_id:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                            options: null
                        dpd_fr_zipcode:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                        # @ADD DND END
                        payment_method:
                            options: null
                        payment_validate:
                            form_type: Symfony\Component\Form\Extension\Core\Type\CheckboxType
                            options: null
                        payment_save_for_later:
                            form_type: Symfony\Component\Form\Extension\Core\Type\CheckboxType
                            options: null
                        additional_data:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                            options: null
                        ship_until:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\CheckoutShipUntilType
                            options:
                                checkout: $checkout
                        po_number:
                            options: null
                        customer_notes:
                            form_type: Symfony\Component\Form\Extension\Core\Type\TextareaType
                            options: null
                        remove_source:
                            options: null
                        late_registration:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\LateRegistrationType
                            options:
                                validation_groups: false
                        customerConsents:
                            form_type: Oro\Bundle\ConsentBundle\Form\Type\ConsentAcceptanceType
                            options:
                                required: true
                                property_path: customerConsents
                                constraints:
                                    -
                                        Oro\Bundle\ConsentBundle\Validator\Constraints\RemovedConsents: null
                                    -
                                        Oro\Bundle\ConsentBundle\Validator\Constraints\RemovedLandingPages: null
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                            options: null
                is_start: false
                is_unavailable_hidden: false
                acl_message: null
                form_type: Oro\Bundle\WorkflowBundle\Form\Type\WorkflowTransitionType
                display_type: dialog
                destination_page: ''
                page_template: null
                dialog_template: null
                init_entities: {  }
                init_routes: {  }
                init_datagrids: {  }
                init_context_attribute: init_context
                message_parameters: {  }
                triggers: {  }
            create_order:
                step_to: checkout
                transition_definition: create_order_transition_definition
                display_type: page
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                    page_component_module: orocheckout/js/app/components/single-page-checkout-component
                    page_component_options:
                        saveStateUrl: $.result.saveStateUrl
                        targetLayoutBlocks:
                            '[data-role="checkout-ship-to"]':
                                - shipping_address_wrapper
                                - payment_methods_wrapper
                                - shipping_methods_wrapper
                                - checkout_order_summary_totals_wrapper
                            'select[data-role="checkout-billing-address"]':
                                - payment_methods_wrapper
                                - shipping_methods_wrapper
                                - checkout_order_summary_totals_wrapper
                            'select[data-role="checkout-billing-address"].custom-address':
                                - billing_address_wrapper
                                - shipping_address_wrapper
                            'select[data-role="checkout-shipping-address"]':
                                - payment_methods_wrapper
                                - shipping_methods_wrapper
                                - checkout_order_summary_totals_wrapper
                            'select[data-role="checkout-shipping-address"].custom-address':
                                - shipping_address_wrapper
                            '[name="shippingMethodType"]':
                                - checkout_order_summary_totals_wrapper
                                - payment_methods_wrapper
                            '[name="paymentMethod"]':
                                - checkout_order_summary_totals_wrapper
                            '[data-role="coupon-code"]':
                                - checkout_coupon_form_container_wrapper
                                - checkout_order_summary_totals_wrapper
                                - payment_methods_wrapper
                                - shipping_methods_wrapper
                                - checkout_order_summary_line_item_wrapper
                                - checkout_form_errors_wrapper
                form_options:
                    form_init:
                        -
                            '@tree':
                                conditions:
                                    '@blank': $payment_validate
                                actions:
                                    -
                                        '@assign_value':
                                            - $payment_validate
                                            - true
                                    -
                                        '@tree':
                                            conditions:
                                                '@blank': $.result.validatePaymentTransaction
                                            actions:
                                                -
                                                    '@call_service_method':
                                                        service: oro_payment.provider.payment_transaction
                                                        method: getActiveValidatePaymentTransaction
                                                        method_parameters:
                                                            - $payment_method
                                                        attribute: $.result.validatePaymentTransaction
                                    -
                                        '@assign_value':
                                            conditions:
                                                '@not_empty':
                                                    - $.result.validatePaymentTransaction
                                            parameters:
                                                - $payment_validate
                                                - false
                        -
                            '@tree':
                                conditions:
                                    '@and':
                                        -
                                            '@not_empty': $checkout.customerUser
                                        -
                                            '@equal':
                                                - $checkout.customerUser.isGuest
                                                - false
                                actions:
                                    -
                                        '@assign_value':
                                            - $customerConsents
                                            - null
                        -
                            '@assign_value':
                                - $billing_address_has_shipping
                                - $ship_to_billing_address
                        -
                            '@tree':
                                conditions:
                                    '@empty': $billing_address
                                actions:
                                    -
                                        '@call_service_method':
                                            attribute: $.result.customerUserAddresses
                                            service: oro_order.manager.order_address
                                            method: getGroupedAddresses
                                            method_parameters:
                                                - $checkout
                                                - billing
                                    -
                                        '@call_service_method':
                                            attribute: $billing_address
                                            service: oro_order.manager.order_address
                                            method: updateFromAbstract
                                            method_parameters:
                                                - $.result.customerUserAddresses.defaultAddress
                        -
                            '@tree':
                                conditions:
                                    '@empty': $shipping_address
                                actions:
                                    -
                                        '@call_service_method':
                                            attribute: $.result.customerUserAddresses
                                            service: oro_order.manager.order_address
                                            method: getGroupedAddresses
                                            method_parameters:
                                                - $checkout
                                                - shipping
                                    -
                                        '@call_service_method':
                                            attribute: $shipping_address
                                            service: oro_order.manager.order_address
                                            method: updateFromAbstract
                                            method_parameters:
                                                - $.result.customerUserAddresses.defaultAddress
                        -
                            '@tree':
                                conditions:
                                    '@blank': $.result.shippingPriceUpdated
                                actions:
                                    -
                                        '@assign_value':
                                            - $.result.shippingPriceUpdated
                                            - true
                                    -
                                        '@run_action_group':
                                            action_group: oro_update_shipping_price
                                            parameters_mapping:
                                                checkout: $checkout
                                    -
                                        '@assign_value':
                                            - $.result.updateCheckoutState
                                            - true
                        -
                            '@run_action_group':
                                action_group: update_checkout_state
                                parameters_mapping:
                                    checkout: $checkout
                                    state_token: $state_token
                                    update_checkout_state: $.result.updateCheckoutState
                                results:
                                    result.updateCheckoutState: $.update_checkout_state
                    attribute_fields:
                        billing_address:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\CheckoutAddressSelectType
                            options:
                                object: $checkout
                                address_type: billing
                                required: true
                                translation_domain: messages
                        shipping_address:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\CheckoutAddressSelectType
                            options:
                                object: $checkout
                                address_type: shipping
                                required: true
                                disabled: $disallow_shipping_address_edit
                                translation_domain: messages
                        ship_to_billing_address:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\ShipToBillingAddressType
                            options: null
                        shipping_method:
                            options:
                                constraints:
                                    -
                                        NotBlank: null
                        shipping_method_type:
                            options:
                                constraints:
                                    -
                                        NotBlank: null
                        #SMASH
                        delivery_phone:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                        dpd_fr_relay_id:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                        #SMASH
                        payment_method:
                            options: null
                        payment_validate:
                            form_type: Symfony\Component\Form\Extension\Core\Type\CheckboxType
                            options: null
                        payment_save_for_later:
                            form_type: Symfony\Component\Form\Extension\Core\Type\CheckboxType
                            options: null
                        additional_data:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                            options: null
                        remove_source:
                            options: null
                        po_number:
                            options: null
                        ship_until:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\CheckoutShipUntilType
                            options:
                                checkout: $checkout
                        late_registration:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\LateRegistrationType
                            options:
                                required: true
                        customer_notes:
                            form_type: Symfony\Component\Form\Extension\Core\Type\TextareaType
                            options: null
                        customerConsents:
                            form_type: Oro\Bundle\ConsentBundle\Form\Type\ConsentAcceptanceType
                            options:
                                required: true
                                property_path: customerConsents
                                constraints:
                                    -
                                        Oro\Bundle\ConsentBundle\Validator\Constraints\RemovedConsents: null
                                    -
                                        Oro\Bundle\ConsentBundle\Validator\Constraints\RemovedLandingPages: null
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                            options: null
                is_start: false
                is_hidden: false
                is_unavailable_hidden: false
                acl_message: null
                form_type: Oro\Bundle\WorkflowBundle\Form\Type\WorkflowTransitionType
                destination_page: ''
                page_template: null
                dialog_template: null
                init_entities: {  }
                init_routes: {  }
                init_datagrids: {  }
                init_context_attribute: init_context
                message_parameters: {  }
                triggers: {  }
            purchase:
                step_to: checkout
                transition_definition: purchase_transition_definition
                is_start: false
                is_hidden: false
                is_unavailable_hidden: false
                acl_message: null
                frontend_options: {  }
                form_type: Oro\Bundle\WorkflowBundle\Form\Type\WorkflowTransitionType
                display_type: dialog
                destination_page: ''
                form_options: {  }
                page_template: null
                dialog_template: null
                init_entities: {  }
                init_routes: {  }
                init_datagrids: {  }
                init_context_attribute: init_context
                message_parameters: {  }
                triggers: {  }
        attributes:
            billing_address:
                property_path: checkout.billingAddress
                type: null
                options: {  }
            shipping_address:
                property_path: checkout.shippingAddress
                type: null
                options: {  }
            save_billing_address:
                property_path: checkout.saveBillingAddress
                type: null
                options: {  }
            save_shipping_address:
                property_path: checkout.saveShippingAddress
                type: null
                options: {  }
            ship_to_billing_address:
                property_path: checkout.shipToBillingAddress
                type: null
                options: {  }
            po_number:
                property_path: checkout.poNumber
                type: null
                options: {  }
            ship_until:
                property_path: checkout.shipUntil
                type: null
                options: {  }
            customer_notes:
                property_path: checkout.customerNotes
                type: null
                options: {  }
            payment_method:
                property_path: checkout.paymentMethod
                type: null
                options: {  }
            shipping_method:
                property_path: checkout.shippingMethod
                type: null
                options: {  }
            shipping_method_type:
                property_path: checkout.shippingMethodType
                type: null
                options: {  }
            # @ADD DND START
            delivery_phone:
                property_path: checkout.delivery_phone
                type: null
                options: {  }
            dpd_fr_relay_id:
                property_path: checkout.dpd_fr_relay_id
                type: null
                options: {  }
            dpd_fr_zipcode:
                type: string
                property_path: null
                options:
                    virtual: true
            # @ADD DND END
            billing_address_has_shipping:
                type: boolean
                property_path: null
                options: {  }
            allow_manual_source_remove:
                type: boolean
                property_path: null
                options: {  }
            disallow_billing_address_edit:
                type: boolean
                property_path: null
                options: {  }
            disallow_shipping_address_edit:
                type: boolean
                property_path: null
                options: {  }
            disallow_shipping_method_edit:
                type: boolean
                property_path: null
                options: {  }
            remove_source:
                type: boolean
                property_path: null
                options: {  }
            clear_source:
                type: boolean
                property_path: null
                options: {  }
            auto_remove_source:
                type: boolean
                property_path: null
                options: {  }
            source_remove_label:
                type: string
                property_path: null
                options: {  }
            edit_order_link:
                type: string
                property_path: null
                options: {  }
            payment_in_progress:
                type: bool
                property_path: null
                options: {  }
            payment_validate:
                type: bool
                property_path: null
                options: {  }
            payment_save_for_later:
                type: bool
                property_path: null
                options: {  }
            additional_data:
                type: string
                property_path: null
                options: {  }
            state_token:
                type: string
                property_path: null
                options: {  }
            order:
                type: entity
                options:
                    class: Oro\Bundle\OrderBundle\Entity\Order
                property_path: null
            visitor:
                type: entity
                options:
                    class: Oro\Bundle\CustomerBundle\Entity\CustomerVisitor
                property_path: null
            email:
                type: string
                property_path: null
                options: {  }
            late_registration:
                type: array
                property_path: null
                options: {  }
            customerConsents:
                type: object
                options:
                    class: Doctrine\Common\Collections\ArrayCollection
                property_path: null
            consents_available:
                type: boolean
                property_path: null
                options: {  }
        steps:
            checkout:
                order: 10
                allowed_transitions:
                    - save_state
                    - create_order
                    - purchase
                    - finish_checkout
                    - payment_error
                    - start_from_quickorderform
                is_final: false
                _is_start: false
                entity_acl: {  }
                position: {  }
            order_created:
                order: 20
                is_final: true
                _is_start: false
                entity_acl: {  }
                allowed_transitions: {  }
                position: {  }
        force_autostart: false
        scopes: {  }
        datagrids: {  }
        disable_operations: {  }
        entity_restrictions: {  }
